---
title: 'Data visualizations: Interactive maps'
author: "Rubén F. Bustillo"
date: '2019-03-25'
output: pdf_document
tags: ''
categories: R
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(collapse = TRUE)

```

**Re**

.   

\

# Libraries

\

```{r, warning=FALSE, message=FALSE}

library(tidyverse)
library(gapminder)
library(echarts4r)
library(gganimate)
library(viridis)
library(ggiraph)
library(widgetframe)
library(DT)

```

\

# Dataset

\

In this post we are going to use a well known dataset called `gapminder` which is in the package of the same name. This dataframe contains the following information for 142 countries:

- ** country **: Name of 142 countries.
- ** continent **: Indicates the continent of each country.
- ** year **: The data range covers the period 1952-2007 (in 5-year increments).
- ** lifeExp **: Indicates the life expectancy of each country in years.
- ** pop **: Population.
- ** gdpPercap **: GDP per capita in inflation-adjusted dollars.

\

**Dataset**:

\

```{r}

# country codes in gapminder::country_codes

gapminder_codes <- gapminder::country_codes

# countries with info in gapminder::gapminder_unfiltered

gapminder <-gapminder::gapminder_unfiltered

# We join both datasets with inner_join to get a dataset with the info by 
# country, continent and country-code

gapminder <- gapminder %>%
  inner_join(gapminder_codes, by= "country") %>%
  mutate(code = iso_alpha)

# A map of the world (Antarctica removed)

world <- map_data("world") %>%
  filter(region != "Antarctica")

```

\

** Interactive maps with {ggiraph}

\

```{r}

gapminder_data <- gapminder %>%
  inner_join(maps::iso3166 %>%
               select(a3, mapname), by= c(code = "a3")) %>%
  mutate(mapname = str_remove(mapname, "\\(.*"))

lifeExp_map <- gapminder_data%>%
  filter(year == 2007) %>%
  right_join(world, by= c(mapname = "region")) %>%
  ggplot() +
  geom_polygon_interactive(color = "white", size = 0.01, 
                           aes(long, lat, group= group, fill= lifeExp,
                               tooltip = sprintf("%s<br/>%s", country, lifeExp))) +
  theme_void() +
  scale_fill_viridis(option = "B") +
  labs(title="Life Expectancy",
       subtitle = "Year: 2007",
       caption = "Source: gapminder.org",
       fill = "Years")  +
  theme(
    axis.line = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    plot.background = element_rect(fill = "snow", color = NA),
    panel.background = element_rect(fill= "snow", color = NA),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    plot.caption = element_text(size = 8, hjust = 1),
    legend.title = element_text(color = "grey40", size = 8),
    legend.text = element_text(color = "grey40", size = 7, hjust = 0),
    legend.position = c(0.05, 0.25),
    plot.margin = unit(c(0.5,2,0.5,1), "cm")) +
  coord_fixed (ratio = 1.3)

widgetframe::frameWidget(ggiraph(code=print(lifeExp_map)))


```


# Mapa evolutivo con el paquete {echarts4r}

\

Tal y como se expuso en un [post anterior](https://rquer.netlify.com/maps3d/), podemos representar la evolución de la esperanza de vida, o de otra variable de interés, en un mapa con el paquete {echarts4r}. Un mapa de estas características nos permite visualizar la evolución de los países y detectar de forma instantánea aquellos países que no están incluidos en el dataframe del paquete {gapminder}. 

\

```{r}

datos_gapminder <- gapminder %>%
  mutate(Name = recode_factor(country,
                              `Congo, Dem. Rep.`= "Dem. Rep. Congo",
                              `Congo, Rep.`= "Congo",
                              `Cote d'Ivoire`= "Côte d'Ivoire",
                              `Central African Republic`= "Central African Rep.",
                              `Yemen, Rep.`= "Yemen",
                              `Korea, Rep.`= "Korea",
                              `Korea, Dem. Rep.`= "Dem. Rep. Korea",
                              `Czech Republic`= "Czech Rep.",
                              `Slovak Republic`= "Slovakia",
                              `Dominican Republic`= "Dominican Rep.",
                              `Equatorial Guinea`= "Eq. Guinea"))

```


```{r, out.width="80%"}

datos_gapminder %>%
  group_by(year) %>%
  e_chart(Name, timeline = TRUE) %>%
  e_map(lifeExp) %>%
  e_visual_map(min= 20, max= 90) %>%
  e_title("Esperanza de vida por país y año", left = "center") 

```

\

Se podría realizar un **gráfico 3D** con una simple modificación del código previo.

\

```{r, out.width="80%"}

datos_gapminder %>%
  group_by(year) %>%
  e_chart(Name, timeline = TRUE) %>%
  e_map_3d(lifeExp) %>%
  e_visual_map(min= 20, max= 90) %>%
  e_title("Esperanza de vida por país y año", left = "center") 

```


